<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <title>MapLibre GL JS Example</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .popup-input textarea { width: 220px; height: 80px; }
        .popup-input button { margin-right: 6px; }
        .popup-note p { margin: 6px 0 0 0; }
        .popup-meta { font-size: 11px; color: #666; margin-top:6px; }
    </style>
</head>
<body>
<div id="map"></div>
    <script>
        var map = new maplibregl.Map({
            container: 'map',
            style: 'https://demotiles.maplibre.org/style.json', // 스타일 URL
            center: [0, 0], // 초기 중심 좌표 [경도, 위도]
            zoom: 2 // 초기 줌 레벨
        });

        // 여러 팝업을 보관하는 배열
        var popups = [];
        // 이미 로드/처리한 노트 ID 트래킹(중복 추가 방지)
        var seenNoteIds = {};
        // 현재 입력용 팝업(편집중인 팝업)은 하나만 허용
        var activeInputPopup = null;

        // 간단한 HTML 이스케이프 함수(XSS 방지)
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function removePopupFromArray(popup) {
            var idx = popups.indexOf(popup);
            if (idx !== -1) popups.splice(idx, 1);
            // if the removed popup was the active input popup, clear the reference
            if (activeInputPopup === popup) activeInputPopup = null;
        }

        // 서버에서 기존 노트 불러오기 (처음 로드)
        function loadNotes() {
            fetch('/api/notes')
                .then(function(res){ return res.json(); })
                .then(function(notes){
                    notes.forEach(function(n){
                        // id가 명확히 null/undefined인지 검사하고, 존재하면 중복 체크
                        if (n.id != null && seenNoteIds[n.id]) return; // 이미 처리된 노트 건너뜀

                        // create a non-editable popup for each saved note
                        var html = '<div class="popup-note"><strong>메모</strong><p>' + escapeHtml(n.content).replace(/\n/g, '<br>') + '</p>';
                        if (n.createdAt) html += '<div class="popup-meta">등록: ' + escapeHtml(n.createdAt) + '</div>';
                        if (n.id != null) html += '<div style="margin-top:6px"><button class="popup-delete-btn" type="button">삭제</button></div>';
                        html += '</div>';
                        var p = new maplibregl.Popup({ closeOnClick: false })
                            .setLngLat([n.lng, n.lat])
                            .setHTML(html)
                            .addTo(map);
                        // noteId가 명확히 존재하면 할당
                        if (n.id != null) p.noteId = n.id;
                        popups.push(p);
                        if (n.id != null) seenNoteIds[n.id] = true;

                        // attempt to attach close-button cleanup in a safe way
                        tryAttachCloseListener(p);
                        // attach delete handler to the popup's delete button (best-effort)
                        (function(popup, note){
                            setTimeout(function(){
                                try {
                                    var el = (typeof popup.getElement === 'function') ? popup.getElement() : (popup._container || null);
                                    if (!el) return;
                                    var del = el.querySelector && el.querySelector('.popup-delete-btn');
                                    if (!del) return;
                                    if (del.__hasDeleteListener) return; del.__hasDeleteListener = true;
                                    del.addEventListener('click', function(ev){
                                        try { ev.stopPropagation(); ev.preventDefault(); } catch(e){}
                                        if (!note || note.id == null) return;
                                        if (!confirm('정말로 이 노트를 삭제하시겠습니까?')) return;
                                        fetch('/api/notes/' + encodeURIComponent(note.id), { method: 'DELETE' })
                                            .then(function(res){ if (!res.ok) throw new Error('삭제 실패'); try{ popup.remove(); }catch(e){} removePopupFromArray(popup); if (note && note.id != null) delete seenNoteIds[note.id]; })
                                            .catch(function(err){ console.error('삭제 오류', err); alert('삭제에 실패했습니다. 콘솔을 확인하세요.'); });
                                    });
                                } catch (err) { /* ignore */ }
                            }, 50);
                        })(p, n);
                    });
                })
                .catch(function(err){
                    console.warn('노트 불러오기 실패', err);
                });
        }

        // 폴링: 주기적으로 새로운 노트를 가져와 추가 (10초)
        function pollNotes() {
            fetch('/api/notes')
                .then(function(res){ return res.json(); })
                .then(function(notes){
                    notes.forEach(function(n){
                        if (n.id == null) return; // id가 없으면 스킵
                        if (seenNoteIds[n.id]) return; // 이미 있으면 스킵

                        var html = '<div class="popup-note"><strong>메모</strong><p>' + escapeHtml(n.content).replace(/\n/g, '<br>') + '</p>';
                        if (n.createdAt) html += '<div class="popup-meta">등록: ' + escapeHtml(n.createdAt) + '</div>';
                        html += '</div>';
                        var p = new maplibregl.Popup({ closeOnClick: false })
                            .setLngLat([n.lng, n.lat])
                            .setHTML(html)
                            .addTo(map);
                        p.noteId = n.id;
                        popups.push(p);
                        seenNoteIds[n.id] = true;

                        tryAttachCloseListener(p);
                    });
                })
                .catch(function(err){
                    console.warn('폴링 중 노트 불러오기 실패', err);
                });
        }

        // helper: attach a close-button listener in a defensive way
        function tryAttachCloseListener(popup) {
            try {
                var el = null;
                if (typeof popup.getElement === 'function') el = popup.getElement();
                // fallback to internal property if available (defensive)
                if (!el && popup._container) el = popup._container;
                if (el) {
                    var closeBtn = el.querySelector && el.querySelector('.maplibregl-popup-close-button');
                    if (closeBtn) {
                        // use once-style listener so it doesn't accumulate
                        var handler = function() { removePopupFromArray(popup); closeBtn.removeEventListener('click', handler); };
                        closeBtn.addEventListener('click', handler);
                    }
                }
            } catch (err) {
                // ignore; this is best-effort cleanup
            }
        }

        // 맵 로드 후 기존 메모 불러오기 및 폴링 시작
        map.on('load', function(){
            loadNotes();
            // 10초 간격 폴링
            setInterval(pollNotes, 10000);
        });

        // 맵 클릭 시 입력 폼 팝업 생성
        map.on('click', function(e) {
            var lng = e.lngLat.lng.toFixed(6);
            var lat = e.lngLat.lat.toFixed(6);

            // If there's already an input popup open, remove it first (only allow one editable popup)
            if (activeInputPopup) {
                try { activeInputPopup.remove(); } catch (err) {}
                removePopupFromArray(activeInputPopup);
                activeInputPopup = null;
            }

            var container = document.createElement('div');
            container.className = 'popup-input';

            var info = document.createElement('div');
            info.style.marginBottom = '6px';
            info.innerHTML = '<strong>위치</strong><br>경도: ' + lng + '<br>위도: ' + lat;
            container.appendChild(info);

            var textarea = document.createElement('textarea');
            textarea.placeholder = '여기에 메모를 입력하세요...';
            container.appendChild(textarea);

            var buttons = document.createElement('div');
            buttons.style.marginTop = '6px';

            var saveBtn = document.createElement('button');
            saveBtn.type = 'button';
            saveBtn.textContent = '저장';
            buttons.appendChild(saveBtn);

            var cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.textContent = '취소';
            buttons.appendChild(cancelBtn);

            container.appendChild(buttons);

            var thisPopup = new maplibregl.Popup({ closeOnClick: false })
                .setLngLat(e.lngLat)
                .setDOMContent(container)
                .addTo(map);

            popups.push(thisPopup);
            activeInputPopup = thisPopup;
            textarea.focus();

            // 저장: 서버에 POST
            saveBtn.addEventListener('click', function() {
                var text = textarea.value.trim();
                var payload = {
                    lng: parseFloat(lng),
                    lat: parseFloat(lat),
                    content: text
                };

                fetch('/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(function(res){
                    if (!res.ok) throw new Error('저장 실패');
                    return res.json();
                })
                .then(function(saved){
                    // Validate saved response strictly
                    var content = (saved && typeof saved.content === 'string') ? saved.content : text || '';
                    var createdAt = (saved && saved.createdAt) ? saved.createdAt : null;
                    var id = (saved && (saved.id != null)) ? saved.id : null;

                    var safe = escapeHtml(content || '').replace(/\n/g, '<br>');
                    var html = '<div class="popup-note"><strong>메모</strong><p>' + (safe || '<em>내용 없음</em>') + '</p>';
                    if (createdAt) html += '<div class="popup-meta">등록: ' + escapeHtml(createdAt) + '</div>';
                    html += '</div>';

                    thisPopup.setHTML(html);
                    if (id != null) {
                        thisPopup.noteId = id;
                        seenNoteIds[id] = true; // 저장된 노트는 이미 처리됨으로 표시
                    }

                    // this popup is no longer an input popup
                    if (activeInputPopup === thisPopup) activeInputPopup = null;

                    // attach close listener for the new readonly popup
                    tryAttachCloseListener(thisPopup);
                })
                .catch(function(err){
                    console.error('저장 중 오류', err);
                    alert('저장에 실패했습니다. 콘솔을 확인하세요.');
                });
            });

            // 취소: 이 팝업만 제거
            cancelBtn.addEventListener('click', function() {
                if (thisPopup) {
                    try { thisPopup.remove(); } catch (err) {}
                    removePopupFromArray(thisPopup);
                    if (activeInputPopup === thisPopup) activeInputPopup = null;
                }
            });

            // 팝업 닫기 버튼 클릭 시 배열에서 제거 (더 안전한 getElement 사용)
            setTimeout(function() {
                try {
                    var popupEl = (typeof thisPopup.getElement === 'function') ? thisPopup.getElement() : (thisPopup._container || null);
                    if (popupEl) {
                        var closeBtn = popupEl.querySelector('.maplibregl-popup-close-button');
                        if (closeBtn) {
                            var handler = function() { removePopupFromArray(thisPopup); closeBtn.removeEventListener('click', handler); };
                            closeBtn.addEventListener('click', handler);
                        }
                    }
                } catch (err) { /* ignore */ }
            }, 50);
        });

    </script>
</body>
</html>